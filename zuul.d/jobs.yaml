- job:
    name: base
    parent: null
    description: |
      The base job all other OpenContrail jobs inherit from.

      Everything starts and ends with this base job. It runs pre-playbooks
      which copy job's git repositories prepared by zuul merger to all
      nodes that are part of the nodeset. It also runs post-playbooks
      that upload logs/ to the logserver.
    pre-run: playbooks/base/pre
    post-run:
      - playbooks/base/post-ssh
      - playbooks/base/post-logs
    roles:
      - zuul: Juniper/zuul-jobs
      - zuul: Juniper/contrail-zuul-jobs
    timeout: 28800
    nodeset:
      nodes:
        - name: ubuntu-xenial
          label: ubuntu-xenial
    secrets:
      - site_logs

- job:
    name: contrail-base
    parent: null
    description: |
      A base job that prepares the builder
    pre-run: playbooks/contrail/pre
    post-run:
      - playbooks/contrail/post
      - playbooks/base/post-ssh
      - playbooks/base/post-logs
    roles:
      - zuul: Juniper/zuul-jobs
      - zuul: Juniper/contrail-zuul-jobs
    timeout: 28800
    secrets:
      - site_logs
      - site_pulp

- job:
    name: contrail-src-base
    parent: contrail-base
    description: |
      A base job that directly copies source code prepared by zuul to the builder node,
      as opposed to the contrail-vnc-base job that uses Android repo to prepare the source tree.
    pre-run: playbooks/contrail/src-pre
    roles:
      - zuul: Juniper/zuul-jobs
      - zuul: Juniper/contrail-zuul-jobs

- job:
    name: contrail-vnc-base
    parent: contrail-base
    description: |
      A base job that prepares Contrail VNC sandbox using Android repo,
      as opposed to the contrail-src-base job that copies the sources directly.
    required-projects:
      - Juniper/contrail-analytics
      - Juniper/contrail-api-client
      - Juniper/contrail-build
      - Juniper/contrail-common
      - Juniper/contrail-controller
      - Juniper/contrail-fabric-utils
      - Juniper/contrail-generateDS
      - Juniper/contrail-heat
      - Juniper/contrail-neutron-plugin
      - Juniper/contrail-nova-extensions
      - Juniper/contrail-nova-vif-driver
      - Juniper/contrail-packages
      - Juniper/contrail-packaging
      - Juniper/contrail-provisioning
      - Juniper/contrail-sandesh
      - Juniper/contrail-specs
      - Juniper/contrail-test
      - Juniper/contrail-test-ci
      - Juniper/contrail-third-party
      - Juniper/contrail-vrouter
      - Juniper/contrail-web-controller
      - Juniper/contrail-web-core
      - Juniper/contrail-web-server-manager
      - Juniper/contrail-web-storage
      - Juniper/contrail-webui-third-party
    irrelevant-files:
      - specs/.*
    pre-run: playbooks/contrail/vnc-pre

- job:
    name: contrail-vnc-build-package-ubuntu-base
    voting: False
    description: |
      Job that tests Contrail VNC (controller, analytics, etc.) packaging

      This is a base job for testing packaging of Contrail VNC for Ubuntu-base
      distributions. Release-based variants of this job are then added
      to the Juniper/contrail-packages project.
    required-projects:
      - Juniper/contrail-analytics
      - Juniper/contrail-api-client
      - Juniper/contrail-build
      - Juniper/contrail-common
      - Juniper/contrail-controller
      - Juniper/contrail-fabric-utils
      - Juniper/contrail-generateDS
      - Juniper/contrail-heat
      - Juniper/contrail-neutron-plugin
      - Juniper/contrail-nova-extensions
      - Juniper/contrail-nova-vif-driver
      - Juniper/contrail-packages
      - Juniper/contrail-packaging
      - Juniper/contrail-provisioning
      - Juniper/contrail-sandesh
      - Juniper/contrail-specs
      - Juniper/contrail-test
      - Juniper/contrail-test-ci
      - Juniper/contrail-third-party
      - Juniper/contrail-vrouter
      - Juniper/contrail-web-controller
      - Juniper/contrail-web-core
      - Juniper/contrail-web-server-manager
      - Juniper/contrail-web-storage
      - Juniper/contrail-webui-third-party
    files:
      - ^debian/contrail/.*$
    run: playbooks/packaging/contrail-vnc
    post-run: playbooks/packaging/post-vnc
    secrets:
      - site_pulp

- job:
    name: contrail-vnc-build-package-el-base
    parent: contrail-vnc-base
    description: |
      Job that tests Contrail VNC (controller, analytics, etc.) packaging

      This is a base job for testing packaging of Contrail VNC for Enterprise
      Linux based distributions (CentOS, RHEL). Release-based variants of this
      job are then added to the Juniper/contrail-packages project.
    run: playbooks/packaging/contrail-vnc-el
    post-run: playbooks/packaging/post-vnc-el
    irrelevant-files:
      - specs/.*
    secrets:
      - site_pulp

- job:
    name: contrail-vnc-build-package-centos74
    parent: contrail-vnc-build-package-el-base
    irrelevant-files:
      - specs/.*
    nodeset:
      nodes:
        - name: builder
          label: centos-7-4-builder

- job:
    name: contrail-vnc-build-package-ubuntu-trusty
    parent: contrail-vnc-build-package-ubuntu-base
    nodeset:
      nodes:
        - name: builder
          label: ubuntu-trusty-builder

- job:
    name: contrail-vnc-build-package-ubuntu-xenial
    parent: contrail-vnc-build-package-ubuntu-base
    nodeset:
      nodes:
        - name: builder
          label: ubuntu-xenial-builder

- job:
    name: contrail-vnc-specs-linter
    voting: false
    run: playbooks/contrail/specs
    nodeset:
      nodes:
        - name: builder
          label: ubuntu-trusty-builder

- job:
    name: contrail-vnc-build-unittest-ubuntu-trusty
    required-projects:
      - Juniper/contrail-build
      - Juniper/contrail-controller
      - Juniper/contrail-generateDS
      - Juniper/contrail-third-party
      - Juniper/contrail-packages
      - Juniper/contrail-packaging
      - Juniper/contrail-provisioning
      - Juniper/contrail-sandesh
      - Juniper/contrail-vrouter
      - Juniper/contrail-nova-vif-driver
      - Juniper/contrail-common
      - Juniper/contrail-analytics
    irrelevant-files:
      - specs/.*
    run: playbooks/unittest/contrail
  #    post-run: playbooks/unittest/post
    nodeset:
      nodes:
        - name: builder
          label: ubuntu-trusty-builder

- job:
    name: contrail-vnc-build-unittest-ubuntu-trusty-prebuilt
    parent: contrail-vnc-build-unittest-ubuntu-trusty
    run: playbooks/unittest/contrail-prebuilt
    voting: false
    vars:
      prebuild_tests: true

- job:
    name: contrail-vnc-unittest-webui
    parent: contrail-vnc-base
    run: playbooks/unittest/webui
    post-run: playbooks/unittest/webui-post
    nodeset:
      nodes:
        - name: builder
          label: centos-7-4-builder

- job:
    name: contrail-vnc-build-containers-centos74
    parent: contrail-src-base
    description: |
      A job that builds the Contrail containers using contrail-container-builder
      and uploads them to a Docker registry.
    irrelevant-files:
      - specs/.*
    required-projects:
      - Juniper/contrail-container-builder
    pre-run:
      - playbooks/docker/setup-docker-registry
      - playbooks/docker/docker-pre
    run: playbooks/docker/centos74
    nodeset:
      nodes:
        - name: builder
          label: centos-7-4-builder
    secrets:
      - site_pulp
      - docker_registry

- job:
    name: contrail-systest-base
    parent: contrail-src-base
    pre-run:
      - playbooks/docker/setup-docker-registry
    post-run: playbooks/sanitytest/post
    secrets:
      - site_pulp
      - docker_registry

- job:
    name: contrail-systest-ubuntu1604-base
    parent: contrail-systest-base
    nodeset:
      nodes:
        - name: builder
          label: ubuntu-xenial-builder

- job:
    name: contrail-systest-ubuntu1604-helm-newton
    parent: contrail-systest-ubuntu1604-base
    description: |
      A job that deploys Contrail and OpenStack containers using contrail-helm-deployer
    required-projects:
      - Juniper/contrail-test-ci
      - Juniper/contrail-test
    run: playbooks/sanitytest/ubuntu1604-helm-newton
    roles:
      - zuul: Juniper/contrail-zuul-jobs
    secrets:
      - docker_registry

- job:
    name: contrail-systest-centos74-kubernetes
    parent: contrail-src-base
    description: |
      A job that deploys Contrail containers and a Kubernetes cluster
      using contrail-ansible-deployer.
    irrelevant-files:
      - specs/.*
    required-projects:
      - Juniper/contrail-ansible-deployer
    pre-run:
      - playbooks/docker/setup-docker-registry
    run: playbooks/docker/centos74-systest-kubernetes
    nodeset:
      nodes:
        - name: contrail-aio
          label: centos-7-4-builder
    secrets:
      - site_pulp
      - docker_registry

- job:
    name: contrail-systest-centos74-kolla-ocata
    parent: contrail-src-base
    description: |
      A job that deploys Contrail containers using contrail-ansible-deployer,
      OpenStack using Kolla and runs the CI sanity testsuite.
    irrelevant-files:
      - specs/.*
    required-projects:
      - Juniper/contrail-ansible-deployer
      - Juniper/contrail-test-ci
      - Juniper/contrail-test
    pre-run:
      - playbooks/docker/setup-docker-registry
    run: playbooks/kolla/centos74-provision-kolla
    post-run: playbooks/sanitytest/post
    nodeset:
      nodes:
        - name: kolla-aio
          label: centos-7-4-builder-xxlarge
    secrets:
      - site_pulp
      - docker_registry

- job:
    name: contrail-vnc-build-containers-centos74-dev
    parent: contrail-vnc-build-containers-centos74
    run: playbooks/docker/centos74-dev
    secrets:
      - site_pulp
      - docker_registry

- job:
    name: contrail-systest-centos74-kolla-ocata-dev
    parent: contrail-systest-centos74-kolla-ocata
    run: playbooks/kolla/centos74-provision-kolla-dev
    secrets:
      - site_pulp
      - docker_registry

- job:
    name: zuul-jobs-linters
    parent: tox
    description: |
      This job runs against contrail-project-config and zuul-jobs, to lint
      ansible playbooks and roles.
    required-projects:
      - kklimonda/contrail-project-config
      - Juniper/zuul-jobs
    vars:
      tox_envlist: linters
      tox_environment:
        ANSIBLE_ROLES_PATH: ~/src/github.com/kklimonda/contrail-project-config/roles:~/src/review.opencontrail.org/Juniper/zuul-jobs/roles

# XXX(kklimonda): temporary jobs to test periodic pipelines
- job:
    name: contrail-vnc-build-package-el-base-nightly
    parent: contrail-vnc-base
    description: |
      Job that tests Contrail VNC (controller, analytics, etc.) packaging

      This is a base job for testing packaging of Contrail VNC for Enterprise
      Linux based distributions (CentOS, RHEL). Release-based variants of this
      job are then added to the Juniper/contrail-packages project.
    run: playbooks/packaging/contrail-vnc-el
    post-run: playbooks/packaging/post-vnc-el-nightly
    irrelevant-files:
      - specs/.*
    secrets:
      - site_pulp

- job:
    name: contrail-vnc-build-containers-nightly
    parent: contrail-src-base
    description: |
      A job that builds the Contrail containers using contrail-container-builder
      and uploads them to a Docker registry.
    irrelevant-files:
      - specs/.*
    required-projects:
      - Juniper/contrail-container-builder
    pre-run: playbooks/docker/docker-pre
    run: playbooks/docker/centos74-nightly
    nodeset:
      nodes:
        - name: builder
          label: centos-7-4-builder
    secrets:
      - site_pulp
      - docker_registry

- job:
    name: contrail-vnc-build-containers-centos74-nightly
    parent: contrail-vnc-build-containers-nightly
    vars:
      linux_release: centos7

- job:
    name: contrail-vnc-build-containers-centos74-ocata-nightly
    parent: contrail-vnc-build-containers-centos74-nightly
    vars:
      openstack_version: ocata
      openstack_subversion: 3

- job:
    name: contrail-vnc-build-containers-centos74-newton-nightly
    parent: contrail-vnc-build-containers-centos74-nightly
    vars:
      openstack_version: newton
      openstack_subversion: 5

- job:
    name: contrail-vnc-build-containers-ubuntu1604-ocata-nightly
    voting: false
    parent: contrail-vnc-build-containers-nightly
    vars:
      linux_distribution: ubuntu
      linux_release: ubuntu1604
      openstack_version: ocata
      openstack_subversion: 3

- job:
    name: contrail-vnc-build-package-centos74-nightly
    parent: contrail-vnc-build-package-el-base-nightly
    irrelevant-files:
      - specs/.*
    vars:
      linux_release: centos7
    nodeset:
      nodes:
        - name: builder
          label: centos-7-4-builder
- job:
    name: contrail-vnc-publish-containers-nightly
    parent: contrail-src-base
    description: |
      A job for publishing Docker containers to DockerHub.
    run: playbooks/docker/publish-nightly
    nodeset:
      nodes:
        - name: builder
          label: centos-7-4-builder
    secrets:
      - site_pulp
      - docker_registry
      - dockerhub

- job:
    name: contrail-vnc-build-containers-ubuntu16-newton-experimental
    parent: contrail-src-base
    description: |
      Builds the Contrail microservices using contrail-container-builder
      and uploads them to a Docker registry.
    irrelevant-files:
      - specs/.*
    required-projects:
      - Juniper/contrail-container-builder
    pre-run:
      - playbooks/docker/setup-docker-registry
      - playbooks/docker/docker-pre
    run: playbooks/docker/build-microservices
    secrets:
      - site_pulp
      - docker_registry
    nodeset:
      nodes:
        - name: builder
          label: centos-7-4-builder
    vars:
      linux_distribution: ubuntu
      openstack_release: newton
